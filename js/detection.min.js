/*!
 * Start Bootstrap - SB Admin 2 v4.1.4 (https://startbootstrap.com/theme/sb-admin-2)
 * Copyright 2013-2021 Start Bootstrap
 * Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-sb-admin-2/blob/master/LICENSE)
 */

var videoPose,webcamPose,weightedDistance,video=document.getElementById("video"),canvasVideo=document.createElement("canvas"),webcam=document.getElementById("webcam"),canvasWebcam=document.createElement("canvas");canvasWebcam.width=webcam.offsetWidth,canvasWebcam.height=webcam.offsetHeight,canvasVideo.width=video.offsetWidth,canvasVideo.height=video.offsetHeight;let detectorConfig,detector;console.log(canvasVideo.width,canvasVideo.height);var compareFlag=!1;function playVideo(){video.play(),compareFlag=!0,window.requestAnimationFrame(captureVideo)}function pauseVideo(){video.pause(),compareFlag=!1}window.onload=async function(){detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){console.log("webcam works!"),console.log(e),webcam.srcObject=e}).catch(function(e){console.log("Something went wrong!")})};async function capture(){canvasWebcam.getContext("2d").drawImage(webcam,0,0,canvasWebcam.width,canvasWebcam.height);webcamPose=await detector.estimatePoses(canvasWebcam)}async function captureVideo(){canvasVideo.getContext("2d").drawImage(video,0,0,canvasVideo.width,canvasVideo.height);videoPose=await detector.estimatePoses(canvasVideo),compareFlag&&(window.requestAnimationFrame(capture),window.requestAnimationFrame(captureVideo),console.log("detect : ",videoPose[0].keypoints,webcamPose[0].keypoints),0<videoPose.length&&0<webcamPose.length&&(weightedDistance=poseSimilarity(webcamPose[0].keypoints,videoPose[0].keypoints),console.log("distance : ",weightedDistance)))}function weightedDistanceMatching(e,o,t){for(var a=1/t[t.length-1],n=0,c=0;c<e.length;c++)n+=t[Math.floor(c/2)]*Math.abs(e[c]-o[c]);return a*n}function convertPoseToVector(e){var n=[],c=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,s=0,d=[],m=Array;return e.forEach(function(e,o){var t=e.x,a=e.y;n.push(t,a),c=Math.min(c,t),i=Math.min(i,a),r=Math.max(r,Math.max(t,a));t=e.score;m&&(a=!1,!m[e.name]&&0!==m[e.name]||(a=m[e.name]),!(a=m[o]||0===m[o]?m[o]:a)&&0!==a||"number"!=typeof a||(t+=a)),s+=t,d.push(t)}),d.push(s),[n,[c/r,i/r,r],d]}function scaleAndTranslate(e,o){var t=o[0],a=o[1],n=o[2];return e.map(function(e,o){return o%2==0?e/n-t:e/n-a})}function L2Normalization(e){var o=0;return e.forEach(function(e){o+=Math.pow(e,2)}),o=Math.sqrt(o),e.map(function(e){return e/o})}function vectorizeAndNormalize(e){e=convertPoseToVector(e);return vectorPoseXY=e[0],vectorPoseTransform=e[1],vectorPoseConfidences=e[2],vectorPoseXY=scaleAndTranslate(vectorPoseXY,vectorPoseTransform),vectorPoseXY=L2Normalization(vectorPoseXY),[vectorPoseXY,vectorPoseConfidences]}function poseSimilarity(e,o){e=vectorizeAndNormalize(e);vectorPose1XY=e[0],vectorPose1Scores=e[1];o=vectorizeAndNormalize(o)[0];return console.log("compare",vectorPose1XY,o),weightedDistanceMatching(vectorPose1XY,o,vectorPose1Scores)}