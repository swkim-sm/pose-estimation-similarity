/*!
 * Start Bootstrap - SB Admin 2 v4.1.4 (https://startbootstrap.com/theme/sb-admin-2)
 * Copyright 2013-2021 Start Bootstrap
 * Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-sb-admin-2/blob/master/LICENSE)
 */

import{Camera}from"./camera.js";import{STATE}from"./params.js";import{setupStats}from"./stats_panel.js";import{setBackendAndEnvFlags}from"./util.js";let detector,camera,stats,rafId,detectorConfig,videoPoses,webcamPoses,startInferenceTime,numInferences=0,inferenceTimeSum=0,lastPanelUpdate=0;var video=document.getElementById("video"),canvasVideo=document.createElement("canvas"),webcam=document.getElementById("webcam"),canvasWebcam=document.createElement("output");function playVideo(){video.play(),window.requestAnimationFrame(captureVideo)}function pauseVideo(){video.pause()}function beginEstimatePosesStats(){startInferenceTime=(performance||Date).now()}function endEstimatePosesStats(){var e=(performance||Date).now();inferenceTimeSum+=e-startInferenceTime,++numInferences;var t;1e3<=e-lastPanelUpdate&&(t=inferenceTimeSum/numInferences,inferenceTimeSum=0,numInferences=0,stats.customFpsPanel.update(1e3/t,120),lastPanelUpdate=e)}async function renderResult(){camera.webcam.readyState<2&&await new Promise(e=>{camera.webcam.onloadeddata=()=>{e(webcam)}}),beginEstimatePosesStats();var e=await detector.estimatePoses(camera.webcam,{maxPoses:STATE.modelConfig.maxPoses,flipHorizontal:!1});endEstimatePosesStats(),camera.drawCtx(),0<e.length&&!STATE.isModelChanged&&camera.drawResults(e)}async function renderPrediction(){await renderResult(),rafId=requestAnimationFrame(renderPrediction)}async function app(){stats=setupStats(),detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet),camera=await Camera.setupCamera(STATE.camera),await setBackendAndEnvFlags(STATE.flags,STATE.backend),renderPrediction()}async function capture(){webcamPoses=await detector.estimatePoses(camera.webcam,{maxPoses:STATE.modelConfig.maxPoses,flipHorizontal:!1}),window.requestAnimationFrame(capture)}async function captureVideo(){videoPoses=await detector.estimatePoses(video,{maxPoses:STATE.modelConfig.maxPoses,flipHorizontal:!1}),weightedDistance=poseSimilarity(webcamPoses[0].keypoints,videoPoses[0].keypoints),console.log(weightedDistance),window.requestAnimationFrame(captureVideo)}function weightedDistanceMatching(e,t,a){for(var o=1/a[a.length-1],n=0,r=0;r<e.length;r++)n+=a[Math.floor(r/2)]*Math.abs(e[r]-t[r]);return o*n}function convertPoseToVector(e){var n=[],r=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,c=0,m=[],d=Array;return e.forEach(function(e,t){var a=e.x,o=e.y;n.push(a,o),r=Math.min(r,a),s=Math.min(s,o),i=Math.max(i,Math.max(a,o));a=e.score;d&&(o=!1,!d[e.name]&&0!==d[e.name]||(o=d[e.name]),!(o=d[t]||0===d[t]?d[t]:o)&&0!==o||"number"!=typeof o||(a*=o)),c+=a,m.push(a)}),m.push(c),[n,[r/i,s/i,i],m]}function scaleAndTranslate(e,t){var a=t[0],o=t[1],n=t[2];return e.map(function(e,t){return t%2==0?e/n-a:e/n-o})}function L2Normalization(e){var t=0;return e.forEach(function(e){t+=Math.pow(e,2)}),t=Math.sqrt(t),e.map(function(e){return e/t})}function vectorizeAndNormalize(e){e=convertPoseToVector(e);return vectorPoseXY=e[0],vectorPoseTransform=e[1],vectorPoseConfidences=e[2],vectorPoseXY=scaleAndTranslate(vectorPoseXY,vectorPoseTransform),vectorPoseXY=L2Normalization(vectorPoseXY),[vectorPoseXY,vectorPoseConfidences]}function poseSimilarity(e,t){e=vectorizeAndNormalize(e);vectorPose1XY=e[0],vectorPose1Scores=e[1];t=vectorizeAndNormalize(t)[0];return weightedDistanceMatching(vectorPose1XY,t,vectorPose1Scores)}app();